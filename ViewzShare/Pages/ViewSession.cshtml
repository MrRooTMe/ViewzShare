@page
@model ViewSessionModel
@using System
@using System.Collections.Generic
@using System.Linq

@functions {
    private static string NormalizeGalleryCategory(GalleryAsset asset)
    {
        if (asset is null)
        {
            return "Interior";
        }

        var category = asset.Category?.Trim();

        if (string.IsNullOrWhiteSpace(category))
        {
            return "Interior";
        }

        if (category.Equals("Exterior", StringComparison.OrdinalIgnoreCase))
        {
            return "Exterior";
        }

        if (category.Equals("Public", StringComparison.OrdinalIgnoreCase))
        {
            return "Public";
        }

        return "Interior";
    }

    private static string GetCategoryLabel(string category) => category switch
    {
        "Exterior" => "חוץ",
        "Public" => "שטחים משותפים",
        _ => "פנים"
    };
}
@{
    Layout = null; // full-screen page without site layout
    ViewData["Title"] = Model.Title;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>@Model.Title</title>

    <style>
        :root {
            --bg: #0e0f13;
            --panel: #16181e;
            --panel-2: #1f2128;
            --text: #e8e8e8;
            --muted: #9da3b1;
            --accent: #FFFFFF;
            --border: #2b2e36;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.45);
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Inter","Rubik","Noto Sans Hebrew",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
            /* window-level scroll snap */
            scroll-snap-type: y mandatory;
            overflow-x: hidden;
        }

        /* Sections */
        .section {
            min-height: 100svh;
            width: 100vw;
            scroll-snap-align: start;
            position: relative; /* for background media */
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 80px 24px;
        }

        /* Background media (video / iframe) */
        .bg-media {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* for <video> */
            background: #000;
            z-index: 0;
        }
        /* Background iframe needs different sizing rules than video */
        .bg-frame-wrap {
            position: absolute;
            inset: 0;
            z-index: 0;
        }

            .bg-frame-wrap iframe {
                width: 100%;
                height: 100%;
                border: 0;
                display: block;
                background: #000;
                /* Avoid capturing scroll by default. Set to auto if you want interaction. */
                pointer-events: auto;
            }

        /* Dark overlay for readability on top of background media */
        .overlay {
            position: absolute;
            inset: 0;
            z-index: 1;
            background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.35));
        }

        /* Foreground content (titles/cards/buttons) */
        .content {
            position: relative;
            z-index: 2;
            width: min(1100px, 94vw);
            text-align: center;
        }

            .content h2 {
                margin: 0 0 12px;
                font-size: clamp(20px,3vw,32px);
                font-weight: 800;
                background: linear-gradient(90deg,var(--accent),#FFFFFF);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }

            .content p {
                margin: 0 0 24px;
                font-size: 14px;
                color: var(--muted);
            }

        html.no-snap,
        body.no-snap {
            scroll-snap-type: none !important;
        }

        .section.gallery-section {
            padding: 0;
            align-items: stretch;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        .gallery-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            height: 100vh;
            padding: 0;
            border: 0;
            border-radius: 0;
            box-shadow: none;
            background: transparent;
            backdrop-filter: none;
            overflow: hidden;
            flex: 1 1 auto;
        }

        .section.liked-section {
            align-items: flex-start;
        }

        .liked-container {
            width: min(1100px,94vw);
            background: linear-gradient(145deg, rgba(22,24,30,0.92), rgba(31,33,40,0.88));
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: calc(var(--radius) + 4px);
            box-shadow: var(--shadow);
            padding: clamp(20px, 3vw, 36px);
            backdrop-filter: blur(12px);
        }

        

        .gallery-header,
        .liked-header {
            text-align: center;
        }

        .section-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            background: rgba(16,163,127,0.12);
            color: rgba(255,255,255,0.85);
        }

        .gallery-header h2,
        .liked-header h2 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: clamp(24px, 4vw, 38px);
            letter-spacing: -0.01em;
        }

        .gallery-header p,
        .liked-header p {
            margin: 0;
            font-size: 15px;
            color: var(--muted);
        }

        .gallery-stage {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            border-radius: 0;
            overflow: hidden;
            background: radial-gradient(circle at top, rgba(255,255,255,0.08), transparent 60%), #07080b;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.65);
            isolation: isolate;
            flex: 1 1 auto;
        }

        @@supports (height: 100svh) {
            .gallery-section,
            .gallery-wrapper,
            .gallery-stage {
                min-height: 100svh;
                height: 100svh;
            }
        }

        .gallery-stage img[data-gallery-stage-img] {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity .35s ease;
        }

        .gallery-stage.has-image img[data-gallery-stage-img] {
            opacity: 1;
        }

        .gallery-stage-fallback,
        .gallery-stage img[data-gallery-stage-img] {
            will-change: transform, opacity;
        }

        .gallery-stage.animate-next .gallery-stage-fallback,
        .gallery-stage.animate-prev .gallery-stage-fallback,
        .gallery-stage.animate-fade .gallery-stage-fallback,
        .gallery-stage.animate-next img[data-gallery-stage-img],
        .gallery-stage.animate-prev img[data-gallery-stage-img],
        .gallery-stage.animate-fade img[data-gallery-stage-img] {
            animation-duration: .48s;
            animation-fill-mode: both;
        }

        .gallery-stage.animate-next .gallery-stage-fallback,
        .gallery-stage.animate-next img[data-gallery-stage-img] {
            animation-name: gallerySlideInFromRight;
        }

        .gallery-stage.animate-prev .gallery-stage-fallback,
        .gallery-stage.animate-prev img[data-gallery-stage-img] {
            animation-name: gallerySlideInFromLeft;
        }

        .gallery-stage.animate-fade .gallery-stage-fallback,
        .gallery-stage.animate-fade img[data-gallery-stage-img] {
            animation-name: galleryStageFade;
        }

        @@keyframes gallerySlideInFromRight {
            from { transform: translate3d(26px, 0, 0); opacity: 0; }
            to { transform: translate3d(0, 0, 0); opacity: 1; }
        }

        @@keyframes gallerySlideInFromLeft {
            from { transform: translate3d(-26px, 0, 0); opacity: 0; }
            to { transform: translate3d(0, 0, 0); opacity: 1; }
        }

        @@keyframes galleryStageFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .gallery-stage-fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px;
            font-size: clamp(16px, 2vw, 20px);
            color: var(--muted);
            background: linear-gradient(135deg, rgba(6,7,10,0.8), rgba(10,12,17,0.85));
        }

        .gallery-stage.has-image .gallery-stage-fallback {
            opacity: 0;
            pointer-events: none;
        }

        .gallery-stage-nav {
            position: absolute;
            top: 50%;
            --nav-translate: translate3d(0, -50%, 0);
            transform: var(--nav-translate);
            width: 56px;
            height: 56px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.45);
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background .2s ease, border-color .2s ease, transform .1s ease;
            z-index: 4;
        }

            .gallery-stage-nav:hover {
                background: rgba(0,0,0,0.65);
                border-color: rgba(255,255,255,0.35);
            }

            .gallery-stage-nav:active {
                transform: var(--nav-translate) scale(0.97);
            }

            .gallery-stage-nav svg {
                width: 22px;
                height: 22px;
                stroke: currentColor;
            }

        .gallery-stage-nav.prev {
            left: clamp(20px, 4vw, 72px);
        }

        .gallery-stage-nav.next {
            right: clamp(20px, 4vw, 72px);
        }

        .gallery-controls {
            position: absolute;
            inset: auto 0 clamp(32px, 7vh, 72px);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(16px, 2vh, 24px);
            padding: 0 24px;
            z-index: 3;
            pointer-events: auto;
        }

        .gallery-thumbs,
        .gallery-tabs {
            pointer-events: auto;
        }

        .gallery-thumbs {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 10px 18px;
            border-radius: 999px;
            background: rgba(6,7,11,0.7);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(18px);
            max-width: min(920px, 92vw);
            width: 100%;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .gallery-thumbs::-webkit-scrollbar {
            display: none;
        }

        .gallery-thumb {
            border: 0;
            padding: 0;
            width: 80px;
            height: 56px;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            opacity: .6;
            transition: opacity .15s ease, transform .15s ease, box-shadow .2s ease;
            background: rgba(255,255,255,0.08);
        }

            .gallery-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .gallery-thumb span {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                font-size: 11px;
                padding: 6px;
                color: rgba(255,255,255,0.8);
                text-align: center;
                background: rgba(255,255,255,0.04);
            }

            .gallery-thumb.active {
                opacity: 1;
                box-shadow: 0 12px 28px rgba(0,0,0,0.45);
            }

        .gallery-tabs {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: clamp(32px, 8vh, 72px);
            display: inline-flex;
            gap: 12px;
            padding: 8px;
            border-radius: 999px;
            background: rgba(7,8,12,0.8);
            border: 1px solid rgba(255,255,255,0.08);
            justify-content: center;
            flex-wrap: wrap;
        }

        .gallery-tab {
            border: 0;
            border-radius: 999px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 700;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            transition: background .18s ease, color .18s ease, transform .1s ease;
        }

            .gallery-tab:hover {
                color: #fff;
                background: rgba(16,163,127,0.12);
            }

            .gallery-tab:focus-visible {
                outline: 2px solid rgba(16,163,127,0.65);
                outline-offset: 2px;
            }

            .gallery-tab.active {
                background: linear-gradient(135deg, rgba(16,163,127,0.35), rgba(16,163,127,0.22));
                color: #fff;
                box-shadow: 0 8px 22px rgba(16,163,127,0.18);
            }

        .gallery-grid {
            display: none;
        }

        .gallery-item {
            position: relative;
            border-radius: calc(var(--radius) - 4px);
            background: rgba(12,13,18,0.85);
            border: 1px solid rgba(255,255,255,0.05);
            overflow: hidden;
            box-shadow: 0 14px 32px rgba(0,0,0,0.35);
        }

            .gallery-item.hidden {
                display: none;
            }

            .gallery-item img {
                width: 100%;
                aspect-ratio: 4 / 3;
                object-fit: cover;
                display: block;
                background: #111;
            }

        @@media (max-width: 700px) {
            .gallery-controls {
                gap: 12px;
                padding: 0 12px;
            }

            .gallery-thumbs {
                border-radius: 24px;
                gap: 8px;
                padding: 10px;
            }

            .gallery-thumb {
                width: 64px;
                height: 46px;
            }

            .gallery-tabs {
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }

            .gallery-stage-nav {
                width: 44px;
                height: 44px;
            }
        }

        .liked-container {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .liked-scroll {
            max-height: clamp(280px, calc(100svh - 220px), 620px);
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-inline-end: 6px;
            scrollbar-gutter: stable;
        }

        .liked-header {
            max-width: 540px;
            margin: 0 auto;
        }

        .liked-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .apt-card {
            background: rgba(15,17,22,0.9);
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: calc(var(--radius) - 2px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .2s ease, box-shadow .2s ease;
        }

            .apt-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 18px 36px rgba(0,0,0,0.45);
            }

        .apt-thumb-frame {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            aspect-ratio: 4 / 3;
            max-height: 320px;
            padding: 12px;
            background: #0f1116;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            box-sizing: border-box;
        }

        .apt-thumb {
            width: 100%;
            height: 100%;
            max-height: 100%;
            object-fit: contain;
            background: #0f1116;
            border-radius: 10px;
        }

        .apt-body {
            padding: 18px 20px 22px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .apt-name {
            font-size: 17px;
            font-weight: 700;
            margin: 0;
            color: #fff;
        }

        .apt-meta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: rgba(255,255,255,0.65);
        }

            .apt-meta .sep {
                opacity: .4;
            }

        .apt-action {
            margin-top: auto;
        }

        .liked-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            border-radius: calc(var(--radius) - 4px);
            border: 1px dashed rgba(255,255,255,0.1);
            color: var(--muted);
            font-size: 15px;
            background: rgba(12,13,18,0.75);
        }

        .btn {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(16,163,127,0.25);
            background: linear-gradient(135deg, rgba(16,163,127,0.22), rgba(16,163,127,0.12));
            color: #e9f7f2;
            font-size: 14px;
            font-weight: 700;
            transition: transform .1s ease, box-shadow .18s ease, border-color .18s ease;
        }

            .btn:hover {
                border-color: rgba(16,163,127,0.45);
                box-shadow: 0 10px 24px rgba(16,163,127,0.2);
                color: #fff;
            }

            .btn:active {
                transform: translateY(1px);
            }

            .btn svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
            }

        /* Sticky logo */
        .logo {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 9999;
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(8px);
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            /* Responsive logo image: small on phones, larger on desktop */
            .logo img {
                display: block;
                width: clamp(90px, 20vw, 180px);
                height: auto;
                object-fit: contain;
            }

            .logo span {
                font-size: 14px;
                font-weight: 700;
                color: var(--text);
            }

        /* Right-side circular arrows */
        .nav-arrows {
            position: fixed;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9998;
        }

        .arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(6px);
            color: #eaecef;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background .15s ease, border-color .15s ease, transform .08s ease;
        }

            .arrow:hover {
                background: rgba(0,0,0,.45);
                border-color: var(--accent);
            }

            .arrow:active {
                transform: translateY(1px);
            }

            .arrow svg {
                width: 18px;
                height: 18px;
                stroke: currentColor;
            }

        /* Top-center banner over the movie */
        .hero-banner {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2; /* above the overlay & video */
            color: #fff;
            background: rgba(0,0,0,0.10); /* ~10% black */
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 700;
            font-size: clamp(14px, 2.5vw, 18px);
            line-height: 1.2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.25);
            text-align: center;
            white-space: nowrap;
            max-width: 90vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Smooth hide when entering interact mode */
        #sec2 .overlay,
        #sec2 .content {
            transition: opacity .25s ease;
        }

        /* Default: background mode (overlay+text visible, iframe not clickable) */
        .bg-frame-wrap iframe {
            pointer-events: none;
        }

        /* Interact mode: hide overlay + text; enable iframe pointer events */
        #sec2.interact .overlay,
        #sec2.interact .content {
            opacity: 0;
            pointer-events: none;
        }

        #sec2.interact .bg-frame-wrap iframe {
            pointer-events: auto;
        }

    </style>
</head>
<body>

    @{
        var likedItems = Model.Session?.Items ?? new List<ApartmentItem>();
        var likedItemsWithImages = likedItems
            .Where(item => !string.IsNullOrWhiteSpace(item.PlanImageUrl))
            .ToList();
        var configuredGalleryAssets = Model.Session?.GalleryAssets ?? new List<GalleryAsset>();
        var hasConfiguredGallery = configuredGalleryAssets.Any();
        List<GalleryAsset> galleryAssets;
        if (hasConfiguredGallery)
        {
            galleryAssets = configuredGalleryAssets;
        }
        else
        {
            galleryAssets = likedItemsWithImages
                .Select(item => new GalleryAsset
                {
                    ImageUrl = item.PlanImageUrl,
                    Category = "Interior"
                })
                .ToList();
        }
        var attemptedLegacyGallery = !hasConfiguredGallery && likedItems.Any();
        var fallbackGalleryHasImages = !hasConfiguredGallery && likedItemsWithImages.Any();
        var galleryItems = galleryAssets
            .Select(asset => new { Asset = asset, Category = NormalizeGalleryCategory(asset) })
            .ToList();
        var galleryCategories = new List<(string Id, string Label)>
        {
            ("Interior", "פנים"),
            ("Exterior", "חוץ"),
            ("Public", "שטחים משותפים")
        };
        var defaultGalleryCategory = galleryCategories[0].Id;
        var hasGalleryItems = galleryItems.Any();
    }

    <div class="logo">
        <img src="@Model.LogoUrl" alt="Project Logo" />
    </div>


    <div class="nav-arrows" aria-label="ניווט בין מקטעים">
        <button class="arrow" type="button" onclick="scrollPrev()" title="למעלה" aria-label="למעלה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
        <button class="arrow" type="button" onclick="scrollNext()" title="למטה" aria-label="למטה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 9l-6 6-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
    </div>

    <!-- SECTION 1: MOVIE AS BACKGROUND -->
    <section id="sec1" class="section">
        <video class="bg-media" src="@Model.MovieUrl" autoplay muted loop playsinline preload="auto"></video>
        <div class="overlay"></div>
        <div class="content">
            <h2>@Model.Session.ProjectId</h2>
        </div>
    </section>

    <!-- SECTION 2: SPLATTER AS BACKGROUND -->
    <section id="sec2" class="section">
        @if (!string.IsNullOrWhiteSpace(Model.SplatterUrl))
        {
            <div class="bg-frame-wrap">
                <iframe src="@Model.SplatterUrl" allow="fullscreen; xr-spatial-tracking; gyroscope; accelerometer"></iframe>
            </div>
            <div class="overlay"></div>
            <div class="content">
                <h2>סיור תלת מימד</h2>
                <p> לחץ כדי להפעיל אינטראקציה</p>
            </div>
        }
        else
        {
            <div class="content">
                <h2>סיור תלת־ממדי (Gaussian Splatting)</h2>
                <p style="color:var(--muted);">לא סופק קישור splatter — הוסיפו ‎?splat=URL לשורת הכתובת.</p>
            </div>
        }
    </section>

    <!-- SECTION 3: PROJECT GALLERY -->
    <section id="sec3" class="section gallery-section">
        <div class="gallery-wrapper" data-gallery>
            <div class="gallery-stage" data-gallery-stage>
                <img data-gallery-stage-img alt="" />
                <div class="gallery-stage-fallback" data-gallery-stage-fallback>
                    <p>בחרו קטגוריה כדי להציג את התמונות במסך מלא.</p>
                </div>
                <button class="gallery-stage-nav prev" type="button" data-gallery-prev aria-label="תמונה קודמת">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                </button>
                <button class="gallery-stage-nav next" type="button" data-gallery-next aria-label="תמונה הבאה">
                    <svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                </button>
                <div class="gallery-controls">
                    <div class="gallery-thumbs" data-gallery-thumbs aria-label="תמונות בקטגוריה הנוכחית"></div>

                    <div class="gallery-tabs" role="tablist">
                        @foreach (var category in galleryCategories)
                        {
                            var isActive = category.Id == defaultGalleryCategory;
                            <button type="button"
                                    class="gallery-tab@(isActive ? " active" : string.Empty)"
                                    role="tab"
                                    aria-selected="@(isActive ? "true" : "false")"
                                    data-gallery-tab
                                    data-category="@category.Id">
                                @category.Label
                            </button>
                        }
                    </div>
                </div>
            </div>

            <div class="gallery-grid" data-gallery-grid hidden aria-hidden="true">
                @foreach (var entry in galleryItems)
                {
                    var asset = entry.Asset;
                    var categoryLabel = GetCategoryLabel(entry.Category);
                    var displayTitle = string.IsNullOrWhiteSpace(categoryLabel) ? "תמונה" : categoryLabel;
                    <figure class="gallery-item"
                            data-gallery-item
                            data-category="@entry.Category"
                            data-image="@asset?.ImageUrl"
                            data-title="@displayTitle"
                            data-label="@categoryLabel">
                        @if (!string.IsNullOrWhiteSpace(asset?.ImageUrl))
                        {
                            <img src="@asset!.ImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                        }
                    </figure>
                }
            </div>
        </div>
    </section>

    <!-- SECTION 4: LIKED APARTMENTS -->
    <section id="sec4" class="section liked-section">
        <div class="liked-container">
            <div class="liked-header">
                <span class="section-eyebrow">תיק הלקוח</span>
                <h2 class="liked-title">דירות שאהבתי</h2>
                <p class="liked-subtitle">כל התכניות שסומנו במהלך הפגישה מרוכזות כאן בתצוגה אחת נוחה.</p>
            </div>

            <div class="liked-scroll">
                @if (likedItems is { Count: > 0 })
                {
                    <div class="liked-grid">
                        @foreach (var item in likedItems)
                        {
                            var displayTitle = !string.IsNullOrWhiteSpace(item.Title) ? item.Title : item.ApartmentId;
                            <article class="apt-card">
                                @if (!string.IsNullOrWhiteSpace(item.PlanImageUrl))
                                {
                                    <div class="apt-thumb-frame">
                                        <img class="apt-thumb" src="@item.PlanImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                                    </div>
                                }
                                <div class="apt-body">
                                    <h3 class="apt-name">@displayTitle</h3>
                                    <div class="apt-meta">
                                        @if (item.Rooms.HasValue)
                                        {
                                            <span>חדרים @item.Rooms.Value</span>
                                        }
                                        @if (item.Rooms.HasValue && item.SizeSqm.HasValue)
                                        {
                                            <span class="sep">•</span>
                                        }
                                        @if (item.SizeSqm.HasValue)
                                        {
                                            <span>מ"ר @item.SizeSqm.Value.ToString("0.#")</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.PdfUrl))
                                    {
                                        <div class="apt-action">
                                            <a class="btn" href="@item.PdfUrl" target="_blank" rel="noopener">
                                                <svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M12 15V3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                הורדת תוכנית
                                            </a>
                                        </div>
                                    }
                                </div>
                            </article>
                        }
                    </div>
                }
                else
                {
                    <div class="liked-empty">
                        אין דירות שמורות כרגע — ודאו שקיים token חוקי ב־URL או התחילו לשמור דירות במהלך הסשן.
                    </div>
                }
            </div>
        </div>
    </section>

    <script>
        const ids = ["sec1","sec2","sec3","sec4"];
        const sec2El = document.getElementById("sec2");
        const scroller = document.scrollingElement || document.documentElement;

        // enable splatter interaction on click
        if (sec2El) {
          sec2El.addEventListener("click", e => {
            if (e.target.closest(".nav-arrows")) return;
            sec2El.classList.add("interact");
          }, { passive: true });
        }

        function resetSplatter() {
          sec2El?.classList.remove("interact");
        }

        function currentIndex() {
          const y = window.scrollY + window.innerHeight / 2;
          let best = 0, bestDist = Infinity;
          for (let i = 0; i < ids.length; i++) {
            const el = document.getElementById(ids[i]);
            if (!el) continue;
            const rect = el.getBoundingClientRect();
            const mid = rect.top + window.scrollY + rect.height / 2;
            const d = Math.abs(mid - y);
            if (d < bestDist) { bestDist = d; best = i; }
          }
          return best;
        }

        // Helper: temporarily disable snap so programmatic scroll isn't blocked
        function withSnapDisabled(fn) {
          document.documentElement.classList.add("no-snap");
          document.body.classList.add("no-snap");
          try { fn(); } finally {
            // give the browser time to start the smooth scroll, then re-enable
            setTimeout(() => {
              document.documentElement.classList.remove("no-snap");
              document.body.classList.remove("no-snap");
            }, 350);
          }
        }

        function scrollToIndex(i) {
          const el = document.getElementById(ids[i]);
          if (!el) return;
          withSnapDisabled(() => {
            // Prefer scrollIntoView for reliability across engines
            el.scrollIntoView({ behavior: "smooth", block: "start" });

            // Fallback kick (some engines need a direct scrollTo on the scroller)
            setTimeout(() => {
              const top = el.offsetTop || 0;
              scroller.scrollTo({ top, behavior: "smooth" });
            }, 0);
          });
        }

        // Upper arrow: go one section up (and reset splatter if we're currently on sec2)
        function scrollPrev() {
          const i = currentIndex();
          if (ids[i] === "sec2") resetSplatter();
          scrollToIndex(Math.max(0, i - 1));
        }

        // Lower arrow: jump straight to LAST section (Liked Apartments)
        function scrollNext() {
          resetSplatter(); // keep transition clean
          scrollToIndex(ids.length - 1); // go to sec4
        }

        // Optional: if user scrolls away from Splatter manually, restore overlay
        let scrollTimer;
        window.addEventListener("scroll", () => {
          clearTimeout(scrollTimer);
          scrollTimer = setTimeout(() => {
            const i = currentIndex();
            if (ids[i] !== "sec2") resetSplatter();
          }, 120);
        }, { passive: true });

        // Expose functions for inline onclick handlers
        window.scrollPrev = scrollPrev;
        window.scrollNext = scrollNext;

        // Fullscreen gallery controller
        const galleryRoot = document.querySelector('[data-gallery]');
        if (galleryRoot) {
          const tabs = Array.from(galleryRoot.querySelectorAll('[data-gallery-tab]'));
          const galleryItems = Array.from(galleryRoot.querySelectorAll('[data-gallery-item]'));
          const stage = galleryRoot.querySelector('[data-gallery-stage]');
          const stageImg = galleryRoot.querySelector('[data-gallery-stage-img]');
          const stageFallback = galleryRoot.querySelector('[data-gallery-stage-fallback]');
          const thumbsContainer = galleryRoot.querySelector('[data-gallery-thumbs]');
          const prevButton = galleryRoot.querySelector('[data-gallery-prev]');
          const nextButton = galleryRoot.querySelector('[data-gallery-next]');
          let fallbackParagraph = stageFallback?.querySelector('p') || null;

          const allItems = galleryItems.map(item => {
            const imgEl = item.querySelector('img');
            return {
              element: item,
              category: item.dataset.category || '',
              src: item.dataset.image || (imgEl ? imgEl.getAttribute('src') : ''),
              title: item.dataset.title || item.querySelector('.gallery-item-title')?.textContent?.trim() || 'תמונה',
              label: item.dataset.label || item.querySelector('.gallery-item-meta')?.textContent?.trim() || ''
            };
          });

          let filteredItems = [];
          let activeIndex = 0;
          let activeCategory = '';
          let interactionLocked = false;
          let animationResetId;

          const ANIMATION_DURATION = 480;
          const SWIPE_THRESHOLD = 40;

          function highlightThumbs() {
            if (!thumbsContainer) return;
            Array.from(thumbsContainer.children).forEach((btn, idx) => {
              btn.classList.toggle('active', idx === activeIndex);
            });
          }

          function setFallbackMessage(message) {
            if (!stageFallback) return;
            if (!fallbackParagraph) {
              fallbackParagraph = document.createElement('p');
              stageFallback.appendChild(fallbackParagraph);
            }
            fallbackParagraph.textContent = message;
          }

          function triggerStageAnimation(direction = 'fade') {
            if (!stage) return;
            const animationClass = direction === 'next'
              ? 'animate-next'
              : direction === 'prev'
                ? 'animate-prev'
                : 'animate-fade';

            stage.classList.remove('animate-next', 'animate-prev', 'animate-fade');
            void stage.offsetWidth; // restart animation
            stage.classList.add(animationClass);

            interactionLocked = true;
            clearTimeout(animationResetId);
            animationResetId = window.setTimeout(() => {
              stage.classList.remove('animate-next', 'animate-prev', 'animate-fade');
              interactionLocked = false;
            }, ANIMATION_DURATION);
          }

          function updateStage(direction = 'fade') {
            const current = filteredItems[activeIndex];
            if (!current) {
              stage?.classList.remove('has-image');
              if (stageImg) {
                stageImg.removeAttribute('src');
                stageImg.removeAttribute('alt');
              }
              setFallbackMessage('אין תמונות להצגה בקטגוריה זו.');
              highlightThumbs();
              triggerStageAnimation(direction);
              return;
            }

            if (stageImg) {
              if (current.src) {
                stageImg.src = current.src;
                stageImg.alt = current.title || current.label || 'תמונה';
              } else {
                stageImg.removeAttribute('src');
                stageImg.removeAttribute('alt');
              }
            }

            if (stage) {
              stage.classList.toggle('has-image', Boolean(current.src));
            }

            if (!current.src) {
              setFallbackMessage(current.title || 'אין תצוגה מקדימה לתמונה זו.');
            }

            highlightThumbs();
            triggerStageAnimation(direction);
          }

          function renderThumbnails() {
            if (!thumbsContainer) return;
            thumbsContainer.innerHTML = '';
            filteredItems.forEach((item, idx) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'gallery-thumb' + (idx === activeIndex ? ' active' : '');
              btn.setAttribute('aria-label', item.title || `תמונה ${idx + 1}`);
              if (item.src) {
                const img = document.createElement('img');
                img.src = item.src;
                img.alt = item.title || item.label || `תמונה ${idx + 1}`;
                img.loading = 'lazy';
                btn.appendChild(img);
              } else {
                const span = document.createElement('span');
                span.textContent = item.title || 'ללא תמונה';
                btn.appendChild(span);
              }
              btn.addEventListener('click', () => {
                const previousIndex = activeIndex;
                activeIndex = idx;
                const direction = idx > previousIndex ? 'next' : 'prev';
                updateStage(direction);
              });
              thumbsContainer.appendChild(btn);
            });
            highlightThumbs();
          }

          function applyGalleryFilter(category) {
            activeCategory = category || '';
            filteredItems = allItems.filter(item => !activeCategory || item.category === activeCategory);

            galleryItems.forEach(item => {
              const matches = !activeCategory || item.dataset.category === activeCategory;
              item.classList.toggle('hidden', !matches);
            });

            if (!filteredItems.length) {
              activeIndex = 0;
              if (thumbsContainer) {
                thumbsContainer.innerHTML = '';
              }
              updateStage();
              return;
            }

            activeIndex = 0;
            renderThumbnails();
            updateStage('fade');
          }

          function navigate(delta, direction) {
            if (!filteredItems.length || interactionLocked) return;
            const nextIndex = (activeIndex + delta + filteredItems.length) % filteredItems.length;
            if (nextIndex === activeIndex && filteredItems.length <= 1) {
              triggerStageAnimation('fade');
              return;
            }
            activeIndex = nextIndex;
            updateStage(direction);
          }

          function showPrev() {
            navigate(-1, 'prev');
          }

          function showNext() {
            navigate(1, 'next');
          }

          prevButton?.addEventListener('click', showPrev);
          nextButton?.addEventListener('click', showNext);

          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              const category = tab.dataset.category || '';
              tabs.forEach(btn => {
                const isActive = btn === tab;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
              });
              applyGalleryFilter(category);
            }, { passive: true });
          });

          const initialTab = tabs.find(btn => btn.classList.contains('active')) || tabs[0];
          if (initialTab) {
            applyGalleryFilter(initialTab.dataset.category || '');
          } else {
            filteredItems = allItems.slice();
            renderThumbnails();
            updateStage();
          }

          if (stage) {
            let startX = 0;
            let startY = 0;
            let pointerId = null;

            const resetPointer = () => {
              if (pointerId !== null) {
                stage.releasePointerCapture?.(pointerId);
              }
              pointerId = null;
            };

            stage.addEventListener('pointerdown', (event) => {
              if (interactionLocked) return;
              if (event.pointerType === 'mouse' && event.button !== 0) return;
              pointerId = event.pointerId;
              startX = event.clientX;
              startY = event.clientY;
              stage.setPointerCapture?.(pointerId);
            });

            stage.addEventListener('pointermove', (event) => {
              if (pointerId === null || event.pointerId !== pointerId) return;
              const deltaX = event.clientX - startX;
              const deltaY = Math.abs(event.clientY - startY);
              if (Math.abs(deltaX) > deltaY && Math.abs(deltaX) > 10) {
                event.preventDefault();
              }
            }, { passive: false });

            const handlePointerEnd = (event) => {
              if (pointerId === null || event.pointerId !== pointerId) return;
              const deltaX = event.clientX - startX;
              const deltaY = Math.abs(event.clientY - startY);
              if (Math.abs(deltaX) > SWIPE_THRESHOLD && Math.abs(deltaX) > deltaY) {
                if (deltaX < 0) {
                  showNext();
                } else {
                  showPrev();
                }
              }
              resetPointer();
            };

            stage.addEventListener('pointerup', handlePointerEnd);
            stage.addEventListener('pointercancel', () => resetPointer());
            stage.addEventListener('pointerleave', () => resetPointer());
          }
        }

        // Hide query parameters after load
        if (window.history.replaceState) {
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }
 

    </script>




</body>
</html>
