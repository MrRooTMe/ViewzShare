@page
@model ViewSessionModel
@using System
@using System.Collections.Generic
@using System.Linq

@functions {
    private static string NormalizeGalleryCategory(GalleryAsset asset)
    {
        if (asset is null)
        {
            return "Interior";
        }

        var category = asset.Category?.Trim();

        if (string.IsNullOrWhiteSpace(category))
        {
            return "Interior";
        }

        if (category.Equals("Exterior", StringComparison.OrdinalIgnoreCase))
        {
            return "Exterior";
        }

        if (category.Equals("Public", StringComparison.OrdinalIgnoreCase))
        {
            return "Public";
        }

        return "Interior";
    }

    private static string GetCategoryLabel(string category) => category switch
    {
        "Exterior" => "חוץ",
        "Public" => "שטחים משותפים",
        _ => "פנים"
    };
}
@{
    Layout = null; // full-screen page without site layout
    ViewData["Title"] = Model.Title;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>@Model.Title</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fotorama/4.6.4/fotorama.js"></script>
    <link rel="stylesheet" href="~/css/view-session.css" asp-append-version="true" />
</head>
<body>

    @{
        var likedItems = Model.Session?.Items ?? new List<ApartmentItem>();
        var likedItemsWithImages = likedItems
            .Where(item => !string.IsNullOrWhiteSpace(item.PlanImageUrl))
            .ToList();
        var configuredGalleryAssets = Model.Session?.GalleryAssets ?? new List<GalleryAsset>();
        var hasConfiguredGallery = configuredGalleryAssets.Any();
        List<GalleryAsset> galleryAssets;
        if (hasConfiguredGallery)
        {
            galleryAssets = configuredGalleryAssets;
        }
        else
        {
            galleryAssets = likedItemsWithImages
                .Select(item => new GalleryAsset
                {
                    ImageUrl = item.PlanImageUrl,
                    Category = "Interior"
                })
                .ToList();
        }
        var galleryItems = galleryAssets
            .Select(asset => new { Asset = asset, Category = NormalizeGalleryCategory(asset) })
            .ToList();
        var galleryCategories = new List<(string Id, string Label)>
        {
            ("Interior", "פנים"),
            ("Exterior", "חוץ"),
            ("Public", "שטחים משותפים")
        };
    }

    <div class="logo">
        <img src="@Model.LogoUrl" alt="Project Logo" />
    </div>


    <div class="nav-arrows" aria-label="ניווט בין מקטעים">
        <button class="arrow" type="button" data-scroll-prev title="למעלה" aria-label="למעלה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
        <button class="arrow" type="button" data-scroll-next title="למטה" aria-label="למטה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 9l-6 6-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
    </div>

    <!-- SECTION 1: MOVIE AS BACKGROUND -->
    <section id="sec1" class="section">
        <video class="bg-media" src="@Model.MovieUrl" autoplay muted loop playsinline preload="auto"></video>
        <div class="overlay"></div>
        <div class="content">
            <h2>@Model.Session.ProjectId</h2>
        </div>
    </section>

    <!-- SECTION 2: SPLATTER AS BACKGROUND -->
    <section id="sec2" class="section">
        @if (!string.IsNullOrWhiteSpace(Model.SplatterUrl))
        {
            <div class="bg-frame-wrap">
                <iframe src="@Model.SplatterUrl" allow="fullscreen; xr-spatial-tracking; gyroscope; accelerometer"></iframe>
            </div>
            <div class="overlay"></div>
            <div class="content">
                <h2>סיור תלת מימד</h2>
                <p> לחץ כדי להפעיל אינטראקציה</p>
            </div>
        }
        else
        {
            <div class="content">
                <h2>סיור תלת־ממדי (Gaussian Splatting)</h2>
                <p class="muted-text">לא סופק קישור splatter — הוסיפו ‎?splat=URL לשורת הכתובת.</p>
            </div>
        }
    </section>

    <!-- SECTION 3: PROJECT GALLERY -->
    <section id="sec3" class="section gallery-section">
        <div class="gallery-shell">
            <div class="gallery-toolbar">
                <div class="gallery-header">
                    <span class="section-eyebrow">גלריית פרויקט</span>
                    <h2>תצוגת מסך מלא</h2>
                    <p>בחרו קטגוריה, דפדפו בתמונות במסך מלא ותעברו בקלות בעזרת פס התמונות.</p>
                </div>
            </div>

            <div class="gallery-layout">
                @foreach (var category in galleryCategories)
                {
                    var categoryItems = galleryItems.Where(entry => entry.Category == category.Id).ToList();
                    if (categoryItems.Count == 0)
                    {
                        continue;
                    }

                    <div class="gallery-category">
                        <h3>@category.Label</h3>
                        <div class="fotorama"
                             data-nav="thumbs"
                             data-width="100%"
                             data-maxheight="600px">
                            @foreach (var entry in categoryItems)
                            {
                                var asset = entry.Asset;
                                if (!string.IsNullOrWhiteSpace(asset?.ImageUrl))
                                {
                                    <img src="@asset!.ImageUrl" alt="@GetCategoryLabel(entry.Category)" />
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>

    <!-- SECTION 4: LIKED APARTMENTS -->
    <section id="sec4" class="section liked-section">
        <div class="liked-container">
            <div class="liked-header">
                <span class="section-eyebrow">תיק הלקוח</span>
                <h2 class="liked-title">דירות שאהבתי</h2>
                <p class="liked-subtitle">כל התכניות שסומנו במהלך הפגישה מרוכזות כאן בתצוגה אחת נוחה.</p>
            </div>

            <div class="liked-scroll">
                @if (likedItems is { Count: > 0 })
                {
                    <div class="liked-grid">
                        @foreach (var item in likedItems)
                        {
                            var displayTitle = !string.IsNullOrWhiteSpace(item.Title) ? item.Title : item.ApartmentId;
                            <article class="apt-card">
                                @if (!string.IsNullOrWhiteSpace(item.PlanImageUrl))
                                {
                                    <div class="apt-thumb-frame">
                                        <img class="apt-thumb" src="@item.PlanImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                                    </div>
                                }
                                <div class="apt-body">
                                    <h3 class="apt-name">@displayTitle</h3>
                                    <div class="apt-meta">
                                        @if (item.Rooms.HasValue)
                                        {
                                            <span>חדרים @item.Rooms.Value</span>
                                        }
                                        @if (item.Rooms.HasValue && item.SizeSqm.HasValue)
                                        {
                                            <span class="sep">•</span>
                                        }
                                        @if (item.SizeSqm.HasValue)
                                        {
                                            <span>מ"ר @item.SizeSqm.Value.ToString("0.#")</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.PdfUrl))
                                    {
                                        <div class="apt-action">
                                            <a class="btn" href="@item.PdfUrl" target="_blank" rel="noopener">
                                                <svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M12 15V3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                הורדת תוכנית
                                            </a>
                                        </div>
                                    }
                                </div>
                            </article>
                        }
                    </div>
                }
                else
                {
                    <div class="liked-empty">
                        אין דירות שמורות כרגע — ודאו שקיים token חוקי ב־URL או התחילו לשמור דירות במהלך הסשן.
                    </div>
                }
            </div>
        </div>
    </section>

    <script src="~/js/view-session.js" asp-append-version="true"></script>
</body>
</html>
