@page
@model ViewSessionModel
@{
    Layout = null; // full-screen page without site layout
    ViewData["Title"] = Model.Title;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>@Model.Title</title>

    <style>
        :root {
            --bg: #0e0f13;
            --panel: #16181e;
            --panel-2: #1f2128;
            --text: #e8e8e8;
            --muted: #9da3b1;
            --accent: #FFFFFF;
            --border: #2b2e36;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.45);
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Inter","Rubik","Noto Sans Hebrew",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
            /* window-level scroll snap */
            scroll-snap-type: y mandatory;
            overflow-x: hidden;
        }

        /* Sections */
        .section {
            min-height: 100svh;
            width: 100vw;
            scroll-snap-align: start;
            position: relative; /* for background media */
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 80px 24px;
        }

        /* Background media (video / iframe) */
        .bg-media {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* for <video> */
            background: #000;
            z-index: 0;
        }
        /* Background iframe needs different sizing rules than video */
        .bg-frame-wrap {
            position: absolute;
            inset: 0;
            z-index: 0;
        }

            .bg-frame-wrap iframe {
                width: 100%;
                height: 100%;
                border: 0;
                display: block;
                background: #000;
                /* Avoid capturing scroll by default. Set to auto if you want interaction. */
                pointer-events: auto;
            }

        /* Dark overlay for readability on top of background media */
        .overlay {
            position: absolute;
            inset: 0;
            z-index: 1;
            background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.35));
        }

        /* Foreground content (titles/cards/buttons) */
        .content {
            position: relative;
            z-index: 2;
            width: min(1100px, 94vw);
            text-align: center;
        }

            .content h2 {
                margin: 0 0 12px;
                font-size: clamp(20px,3vw,32px);
                font-weight: 800;
                background: linear-gradient(90deg,var(--accent),#FFFFFF); /* header colors*/
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }

            .content p {
                margin: 0 0 24px;
                font-size: 14px;
                color: var(--muted);
            }

        /* Cards section (not background) */
        .cards-panel {
            width: min(1100px,94vw);
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: min(75vh,840px);
            text-align: start;
        }

        .cards-scroll {
            padding: 16px;
            overflow-y: auto;
            height: 100%;
        }

        .grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
        }

        .card {
            background: var(--panel-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform .18s ease, box-shadow .18s ease;
        }

            .card:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 28px rgba(0,0,0,.5);
            }

        .thumb {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            display: block;
            background: #111;
        }

        .card-body {
            padding: 14px 16px 18px;
        }

        .apt-title {
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 6px;
            color: #fff;
        }

        .specs {
            font-size: 13px;
            color: var(--muted);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sep {
            opacity: .4;
        }

        .actions {
            margin-top: 12px;
        }

        .btn {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg,#2f3137,#26282e);
            color: #e9eaea;
            font-size: 14px;
            font-weight: 700;
            transition: background .15s ease, border-color .15s ease, transform .08s ease;
        }

            .btn:hover {
                background: linear-gradient(180deg,#3a3d44,#2f3137);
                border-color: var(--accent);
                color: #fff;
            }

            .btn:active {
                transform: translateY(1px);
            }

        /* Sticky logo */
        .logo {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 9999;
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(8px);
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            /* Responsive logo image: small on phones, larger on desktop */
            .logo img {
                display: block;
                width: clamp(90px, 20vw, 180px);
                height: auto;
                object-fit: contain;
            }

            .logo span {
                font-size: 14px;
                font-weight: 700;
                color: var(--text);
            }

        /* Right-side circular arrows */
        .nav-arrows {
            position: fixed;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9998;
        }

        .arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(6px);
            color: #eaecef;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background .15s ease, border-color .15s ease, transform .08s ease;
        }

            .arrow:hover {
                background: rgba(0,0,0,.45);
                border-color: var(--accent);
            }

            .arrow:active {
                transform: translateY(1px);
            }

            .arrow svg {
                width: 18px;
                height: 18px;
                stroke: currentColor;
            }

        /* Top-center banner over the movie */
        .hero-banner {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2; /* above the overlay & video */
            color: #fff;
            background: rgba(0,0,0,0.10); /* ~10% black */
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 700;
            font-size: clamp(14px, 2.5vw, 18px);
            line-height: 1.2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.25);
            text-align: center;
            white-space: nowrap;
            max-width: 90vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Smooth hide when entering interact mode */
        #sec2 .overlay,
        #sec2 .content {
            transition: opacity .25s ease;
        }

        /* Default: background mode (overlay+text visible, iframe not clickable) */
        .bg-frame-wrap iframe {
            pointer-events: none;
        }

        /* Interact mode: hide overlay + text; enable iframe pointer events */
        #sec2.interact .overlay,
        #sec2.interact .content {
            opacity: 0;
            pointer-events: none;
        }

        #sec2.interact .bg-frame-wrap iframe {
            pointer-events: auto;
        }

    </style>
</head>
<body>

    <div class="logo">
        <img src="@Model.LogoUrl" alt="Project Logo" />
    </div>


    <div class="nav-arrows" aria-label="ניווט בין מקטעים">
        <button class="arrow" type="button" onclick="scrollPrev()" title="למעלה" aria-label="למעלה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
        <button class="arrow" type="button" onclick="scrollNext()" title="למטה" aria-label="למטה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 9l-6 6-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
    </div>

    <!-- SECTION 1: MOVIE AS BACKGROUND -->
    <section id="sec1" class="section">
        <video class="bg-media" src="@Model.MovieUrl" autoplay muted loop playsinline preload="auto"></video>
        <div class="overlay"></div>
        <div class="content">
            <h2>@Model.Session.ProjectId</h2>
        </div>
    </section>

    <!-- SECTION 2: SPLATTER AS BACKGROUND -->
    <section id="sec2" class="section">
        @if (!string.IsNullOrWhiteSpace(Model.SplatterUrl))
        {
            <div class="bg-frame-wrap">
                <iframe src="@Model.SplatterUrl" allow="fullscreen; xr-spatial-tracking; gyroscope; accelerometer"></iframe>
            </div>
            <div class="overlay"></div>
            <div class="content">
                <h2>סיור תלת מימד</h2>
                <p> לחץ כדי להפעיל אינטראקציה</p>
            </div>
        }
        else
        {
            <div class="content">
                <h2>סיור תלת־ממדי (Gaussian Splatting)</h2>
                <p style="color:var(--muted);">לא סופק קישור splatter — הוסיפו ‎?splat=URL לשורת הכתובת.</p>
            </div>
        }
    </section>

    <!-- SECTION 3: APARTMENTS (foreground cards) -->
    <section id="sec3" class="section">
        <div class="content" style="text-align:center; margin-bottom:16px;">
            <h2>דירות שאהבתי</h2>
            <p>רשימת התכניות שנשמרו במהלך המפגש.</p>
        </div>

        <div class="cards-panel">
            <div class="cards-scroll">
                @if (Model.Session?.Items is { Count: > 0 })
                {
                    <div class="grid">
                        @foreach (var item in Model.Session.Items)
                        {
                            <article class="card">
                                @if (!string.IsNullOrEmpty(item.PlanImageUrl))
                                {
                                    <img class="thumb" src="@item.PlanImageUrl" alt="@item.Title" loading="lazy" />
                                }
                                <div class="card-body">
                                    <div class="apt-title">@(!string.IsNullOrEmpty(item.Title) ? item.Title : item.ApartmentId)</div>
                                    <div class="specs">
                                        @if (item.Rooms.HasValue)
                                        {
                                            <span>חדרים&nbsp;@item.Rooms.Value</span>
                                        }
                                        @if (item.Rooms.HasValue && item.SizeSqm.HasValue)
                                        {
                                            <span class="sep">•</span>
                                        }
                                        @if (item.SizeSqm.HasValue)
                                        {
                                            <span>מ"ר&nbsp;@item.SizeSqm</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(item.PdfUrl))
                                    {
                                        <div class="actions">
                                            <a class="btn" href="@item.PdfUrl" target="_blank" rel="noopener">
                                                <svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M12 15V3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                הורדת תוכנית
                                            </a>
                                        </div>
                                    }
                                </div>
                            </article>
                        }
                    </div>
                }
                else
                {
                    <div style="height:200px;color:var(--muted);display:flex;align-items:center;justify-content:center;font-size:14px;">
                        אין דירות שמורות — ודאו שקיים token חוקי ב־URL.
                    </div>
                }
            </div>
        </div>
    </section>

    <script>
        const ids = ["sec1","sec2","sec3"];
        const sec2El = document.getElementById("sec2");
        const scroller = document.scrollingElement || document.documentElement;

        // enable splatter interaction on click
        if (sec2El) {
          sec2El.addEventListener("click", e => {
            if (e.target.closest(".nav-arrows")) return;
            sec2El.classList.add("interact");
          }, { passive: true });
        }

        function resetSplatter() {
          sec2El?.classList.remove("interact");
        }

        function currentIndex() {
          const y = window.scrollY + window.innerHeight / 2;
          let best = 0, bestDist = Infinity;
          for (let i = 0; i < ids.length; i++) {
            const el = document.getElementById(ids[i]);
            if (!el) continue;
            const rect = el.getBoundingClientRect();
            const mid = rect.top + window.scrollY + rect.height / 2;
            const d = Math.abs(mid - y);
            if (d < bestDist) { bestDist = d; best = i; }
          }
          return best;
        }

        // Helper: temporarily disable snap so programmatic scroll isn't blocked
        function withSnapDisabled(fn) {
          document.documentElement.classList.add("no-snap");
          document.body.classList.add("no-snap");
          try { fn(); } finally {
            // give the browser time to start the smooth scroll, then re-enable
            setTimeout(() => {
              document.documentElement.classList.remove("no-snap");
              document.body.classList.remove("no-snap");
            }, 350);
          }
        }

        function scrollToIndex(i) {
          const el = document.getElementById(ids[i]);
          if (!el) return;
          withSnapDisabled(() => {
            // Prefer scrollIntoView for reliability across engines
            el.scrollIntoView({ behavior: "smooth", block: "start" });

            // Fallback kick (some engines need a direct scrollTo on the scroller)
            setTimeout(() => {
              const top = el.offsetTop || 0;
              scroller.scrollTo({ top, behavior: "smooth" });
            }, 0);
          });
        }

        // Upper arrow: go one section up (and reset splatter if we're currently on sec2)
        function scrollPrev() {
          const i = currentIndex();
          if (ids[i] === "sec2") resetSplatter();
          scrollToIndex(Math.max(0, i - 1));
        }

        // Lower arrow: jump straight to LAST section (Liked Apartments / API)
        function scrollNext() {
          resetSplatter(); // keep transition clean
          scrollToIndex(ids.length - 1); // go to sec3
        }

        // Optional: if user scrolls away from Splatter manually, restore overlay
        let scrollTimer;
        window.addEventListener("scroll", () => {
          clearTimeout(scrollTimer);
          scrollTimer = setTimeout(() => {
            const i = currentIndex();
            if (ids[i] !== "sec2") resetSplatter();
          }, 120);
        }, { passive: true });

        // Expose functions for inline onclick handlers
        window.scrollPrev = scrollPrev;
        window.scrollNext = scrollNext;

        // Hide query parameters after load
        if (window.history.replaceState) {
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }
 

    </script>




</body>
</html>
