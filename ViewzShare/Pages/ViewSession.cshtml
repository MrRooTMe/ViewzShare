@page
@model ViewSessionModel
@using System
@using System.Collections.Generic
@using System.Linq

@functions {
    private static string NormalizeGalleryCategory(GalleryAsset asset)
    {
        if (asset is null)
        {
            return "Interior";
        }

        var category = asset.Category?.Trim();

        if (string.IsNullOrWhiteSpace(category))
        {
            return "Interior";
        }

        if (category.Equals("Exterior", StringComparison.OrdinalIgnoreCase))
        {
            return "Exterior";
        }

        if (category.Equals("Public", StringComparison.OrdinalIgnoreCase))
        {
            return "Public";
        }

        return "Interior";
    }

    private static string GetCategoryLabel(string category) => category switch
    {
        "Exterior" => "חוץ",
        "Public" => "שטחים משותפים",
        _ => "פנים"
    };
}
@{
    Layout = null; // full-screen page without site layout
    ViewData["Title"] = Model.Title;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>@Model.Title</title>
    <link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css" />
    <link rel="stylesheet" href="~/css/view-session.css" asp-append-version="true" />
</head>
<body>

    @{
        var likedItems = Model.Session?.Items ?? new List<ApartmentItem>();
        var likedItemsWithImages = likedItems
            .Where(item => !string.IsNullOrWhiteSpace(item.PlanImageUrl))
            .ToList();
        var configuredGalleryAssets = Model.Session?.GalleryAssets ?? new List<GalleryAsset>();
        var hasConfiguredGallery = configuredGalleryAssets.Any();
        List<GalleryAsset> galleryAssets;
        if (hasConfiguredGallery)
        {
            galleryAssets = configuredGalleryAssets;
        }
        else
        {
            galleryAssets = likedItemsWithImages
                .Select(item => new GalleryAsset
                {
                    ImageUrl = item.PlanImageUrl,
                    Category = "Interior"
                })
                .ToList();
        }
        var attemptedLegacyGallery = !hasConfiguredGallery && likedItems.Any();
        var fallbackGalleryHasImages = !hasConfiguredGallery && likedItemsWithImages.Any();
        var galleryItems = galleryAssets
            .Select(asset => new { Asset = asset, Category = NormalizeGalleryCategory(asset) })
            .ToList();
        var galleryCategories = new List<(string Id, string Label)>
        {
            ("Interior", "פנים"),
            ("Exterior", "חוץ"),
            ("Public", "שטחים משותפים")
        };
        var defaultGalleryCategory = galleryCategories[0].Id;
        var hasGalleryItems = galleryItems.Any();
    }

    <div class="logo">
        <img src="@Model.LogoUrl" alt="Project Logo" />
    </div>


    <div class="nav-arrows" aria-label="ניווט בין מקטעים">
        <button class="arrow" type="button" data-scroll-prev title="למעלה" aria-label="למעלה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
        <button class="arrow" type="button" data-scroll-next title="למטה" aria-label="למטה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 9l-6 6-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
    </div>

    <!-- SECTION 1: MOVIE AS BACKGROUND -->
    <section id="sec1" class="section">
        <video class="bg-media" src="@Model.MovieUrl" autoplay muted loop playsinline preload="auto"></video>
        <div class="overlay"></div>
        <div class="content">
            <h2>@Model.Session.ProjectId</h2>
        </div>
    </section>

    <!-- SECTION 2: SPLATTER AS BACKGROUND -->
    <section id="sec2" class="section">
        @if (!string.IsNullOrWhiteSpace(Model.SplatterUrl))
        {
            <div class="bg-frame-wrap">
                <iframe src="@Model.SplatterUrl" allow="fullscreen; xr-spatial-tracking; gyroscope; accelerometer"></iframe>
            </div>
            <div class="overlay"></div>
            <div class="content">
                <h2>סיור תלת מימד</h2>
                <p> לחץ כדי להפעיל אינטראקציה</p>
            </div>
        }
        else
        {
            <div class="content">
                <h2>סיור תלת־ממדי (Gaussian Splatting)</h2>
                <p class="muted-text">לא סופק קישור splatter — הוסיפו ‎?splat=URL לשורת הכתובת.</p>
            </div>
        }
    </section>

    <!-- SECTION 3: PROJECT GALLERY -->
    <section id="sec3" class="section gallery-section">
        <div class="gallery-shell" data-gallery-root>
            <div class="gallery-toolbar">
                <div class="gallery-header">
                    <span class="section-eyebrow">גלריית פרויקט</span>
                    <h2>תצוגת מסך מלא</h2>
                    <p>בחרו קטגוריה, דפדפו בתמונות במסך מלא ותעברו בקלות בעזרת פס התמונות.</p>
                </div>
            </div>

            <div class="gallery-layout">
                <div class="gallery-hero">
                    <div class="gallery-overlay-top"></div>
                    <div class="gallery-meta">גלריה</div>
                    <img class="gallery-preview-img" data-gallery-preview-img alt="" />
                    <div class="gallery-controls" aria-hidden="true">
                        <button class="gallery-arrow-btn" type="button" data-gallery-prev>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M15 6l-6 6 6 6" />
                            </svg>
                        </button>
                        <button class="gallery-arrow-btn" type="button" data-gallery-next>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 6l6 6-6 6" />
                            </svg>
                        </button>
                        <button class="gallery-fullscreen-btn" type="button" data-gallery-fullscreen aria-label="מסך מלא" aria-pressed="false">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 3H4v5" />
                                <path d="M15 3h5v5" />
                                <path d="M9 21H4v-5" />
                                <path d="M15 21h5v-5" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="gallery-bottom">
                    <div class="gallery-tabs" role="tablist">
                        @foreach (var category in galleryCategories)
                        {
                            var isActive = category.Id == defaultGalleryCategory;
                            <button type="button"
                                    class="gallery-tab@(isActive ? " active" : string.Empty)"
                                    role="tab"
                                    aria-selected="@(isActive ? "true" : "false")"
                                    data-gallery-tab
                                    data-category="@category.Id">
                                @category.Label
                            </button>
                        }
                    </div>
                    <div class="gallery-thumbs" data-gallery-thumbs aria-label="תמונות בקטגוריה הנוכחית">
                        @foreach (var entry in galleryItems)
                        {
                            var asset = entry.Asset;
                            var categoryLabel = GetCategoryLabel(entry.Category);
                            var displayTitle = string.IsNullOrWhiteSpace(categoryLabel) ? "תמונה" : categoryLabel;
                            <a class="gallery-thumb"
                               href="@asset?.ImageUrl"
                               data-gallery-thumb
                               data-category="@entry.Category"
                               data-image="@asset?.ImageUrl"
                               data-title="@displayTitle"
                               data-label="@categoryLabel"
                               data-pswp-width="1600"
                               data-pswp-height="900">
                                @if (!string.IsNullOrWhiteSpace(asset?.ImageUrl))
                                {
                                    <img src="@asset!.ImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                                }
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 4: LIKED APARTMENTS -->
    <section id="sec4" class="section liked-section">
        <div class="liked-container">
            <div class="liked-header">
                <span class="section-eyebrow">תיק הלקוח</span>
                <h2 class="liked-title">דירות שאהבתי</h2>
                <p class="liked-subtitle">כל התכניות שסומנו במהלך הפגישה מרוכזות כאן בתצוגה אחת נוחה.</p>
            </div>

            <div class="liked-scroll">
                @if (likedItems is { Count: > 0 })
                {
                    <div class="liked-grid">
                        @foreach (var item in likedItems)
                        {
                            var displayTitle = !string.IsNullOrWhiteSpace(item.Title) ? item.Title : item.ApartmentId;
                            <article class="apt-card">
                                @if (!string.IsNullOrWhiteSpace(item.PlanImageUrl))
                                {
                                    <div class="apt-thumb-frame">
                                        <img class="apt-thumb" src="@item.PlanImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                                    </div>
                                }
                                <div class="apt-body">
                                    <h3 class="apt-name">@displayTitle</h3>
                                    <div class="apt-meta">
                                        @if (item.Rooms.HasValue)
                                        {
                                            <span>חדרים @item.Rooms.Value</span>
                                        }
                                        @if (item.Rooms.HasValue && item.SizeSqm.HasValue)
                                        {
                                            <span class="sep">•</span>
                                        }
                                        @if (item.SizeSqm.HasValue)
                                        {
                                            <span>מ"ר @item.SizeSqm.Value.ToString("0.#")</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.PdfUrl))
                                    {
                                        <div class="apt-action">
                                            <a class="btn" href="@item.PdfUrl" target="_blank" rel="noopener">
                                                <svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M12 15V3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                הורדת תוכנית
                                            </a>
                                        </div>
                                    }
                                </div>
                            </article>
                        }
                    </div>
                }
                else
                {
                    <div class="liked-empty">
                        אין דירות שמורות כרגע — ודאו שקיים token חוקי ב־URL או התחילו לשמור דירות במהלך הסשן.
                    </div>
                }
            </div>
        </div>
    </section>

    <script src="~/js/view-session.js" asp-append-version="true"></script>
</body>
</html>
