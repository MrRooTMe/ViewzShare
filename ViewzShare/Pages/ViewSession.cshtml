@page
@model ViewSessionModel
@using System
@using System.Collections.Generic
@using System.Linq

@functions {
    private static string NormalizeGalleryCategory(GalleryAsset asset)
    {
        if (asset is null)
        {
            return "Interior";
        }

        var category = asset.Category?.Trim();

        if (string.IsNullOrWhiteSpace(category))
        {
            return "Interior";
        }

        if (category.Equals("Exterior", StringComparison.OrdinalIgnoreCase))
        {
            return "Exterior";
        }

        if (category.Equals("Public", StringComparison.OrdinalIgnoreCase))
        {
            return "Public";
        }

        return "Interior";
    }

    private static string GetCategoryLabel(string category) => category switch
    {
        "Exterior" => "חוץ",
        "Public" => "שטחים משותפים",
        _ => "פנים"
    };
}
@{
    Layout = null; // full-screen page without site layout
    ViewData["Title"] = Model.Title;
}

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>@Model.Title</title>
    <link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css" />

    <style>
        :root {
            --bg: #0e0f13;
            --panel: #16181e;
            --panel-2: #1f2128;
            --text: #e8e8e8;
            --muted: #9da3b1;
            --accent: #FFFFFF;
            --border: #2b2e36;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.45);
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "Inter","Rubik","Noto Sans Hebrew",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
            /* window-level scroll snap */
            scroll-snap-type: y mandatory;
            overflow-x: hidden;
        }

        /* Sections */
        .section {
            min-height: 100svh;
            width: 100vw;
            scroll-snap-align: start;
            position: relative; /* for background media */
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 80px 24px;
        }

        /* Background media (video / iframe) */
        .bg-media {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* for <video> */
            background: #000;
            z-index: 0;
        }
        /* Background iframe needs different sizing rules than video */
        .bg-frame-wrap {
            position: absolute;
            inset: 0;
            z-index: 0;
        }

            .bg-frame-wrap iframe {
                width: 100%;
                height: 100%;
                border: 0;
                display: block;
                background: #000;
                /* Avoid capturing scroll by default. Set to auto if you want interaction. */
                pointer-events: auto;
            }

        /* Dark overlay for readability on top of background media */
        .overlay {
            position: absolute;
            inset: 0;
            z-index: 1;
            background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.35));
        }

        /* Foreground content (titles/cards/buttons) */
        .content {
            position: relative;
            z-index: 2;
            width: min(1100px, 94vw);
            text-align: center;
        }

            .content h2 {
                margin: 0 0 12px;
                font-size: clamp(20px,3vw,32px);
                font-weight: 800;
                background: linear-gradient(90deg,var(--accent),#FFFFFF);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }

            .content p {
                margin: 0 0 24px;
                font-size: 14px;
                color: var(--muted);
            }

        html.no-snap,
        body.no-snap {
            scroll-snap-type: none !important;
        }

        .section.gallery-section {
            padding: clamp(20px, 3vw, 32px);
            align-items: stretch;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at 20% 20%, rgba(16,163,127,0.18), rgba(16,163,127,0)),
                        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.08), rgba(255,255,255,0));
        }

        .gallery-shell {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: clamp(16px, 2vw, 24px);
            width: 100%;
            height: 100%;
            border-radius: clamp(var(--radius), 2vw, 20px);
            padding: clamp(18px, 2vw, 28px);
            background: linear-gradient(180deg, rgba(22,24,30,0.92), rgba(16,18,25,0.96));
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 30px 120px rgba(0,0,0,0.35);
            overflow: hidden;
        }

        .section.liked-section {
            align-items: flex-start;
        }

        .liked-container {
            width: min(1100px,94vw);
            background: linear-gradient(145deg, rgba(22,24,30,0.92), rgba(31,33,40,0.88));
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: calc(var(--radius) + 4px);
            box-shadow: var(--shadow);
            padding: clamp(20px, 3vw, 36px);
            backdrop-filter: blur(12px);
        }

        

        .gallery-header,
        .liked-header {
            text-align: center;
        }

        .section-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: .04em;
            text-transform: uppercase;
            background: rgba(16,163,127,0.12);
            color: rgba(255,255,255,0.85);
        }

        .gallery-header h2,
        .liked-header h2 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: clamp(24px, 4vw, 38px);
            letter-spacing: -0.01em;
        }

        .gallery-header p,
        .liked-header p {
            margin: 0;
            font-size: 15px;
            color: var(--muted);
        }

        .gallery-layout {
            display: flex;
            flex-direction: column;
            gap: clamp(14px, 1.8vw, 22px);
            height: 100%;
        }

        .gallery-toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .gallery-tabs {
            display: inline-flex;
            gap: 10px;
            padding: 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(12px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        }

        .gallery-tab {
            border: 0;
            padding: 10px 16px;
            border-radius: 999px;
            background: transparent;
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: pointer;
            transition: background .15s ease, color .15s ease, transform .12s ease;
        }

            .gallery-tab:hover { background: rgba(255,255,255,0.07); }
            .gallery-tab:focus-visible { outline: 2px solid rgba(16,163,127,0.65); outline-offset: 2px; }
            .gallery-tab.active { background: rgba(16,163,127,0.2); color: #fff; transform: translateY(-1px); }

        .gallery-hero {
            position: relative;
            flex: 1 1 auto;
            min-height: 0;
            border-radius: clamp(14px, 1.8vw, 20px);
            overflow: hidden;
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.12), rgba(255,255,255,0))
                        , linear-gradient(135deg, rgba(7,9,14,0.92), rgba(8,10,15,0.85));
            display: grid;
            place-items: center;
            isolation: isolate;
        }

        .gallery-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            transition: transform .25s ease;
        }

        .gallery-hero:hover .gallery-preview-img { transform: scale(1.01); }

        .gallery-preview-fallback {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            padding: clamp(18px, 3vw, 32px);
            text-align: center;
            color: var(--muted);
            background: linear-gradient(135deg, rgba(5,6,9,0.85), rgba(7,9,14,0.8));
        }

        .gallery-overlay-top {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 12% 10%, rgba(16,163,127,0.22), transparent 26%);
            pointer-events: none;
        }

        .gallery-meta {
            position: absolute;
            top: clamp(14px, 2vw, 18px);
            left: clamp(16px, 3vw, 28px);
            background: rgba(0,0,0,0.4);
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            color: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }

        .gallery-thumbs-bar {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            padding: clamp(12px, 2vw, 18px);
            background: linear-gradient(180deg, rgba(7,9,14,0) 0%, rgba(7,9,14,0.68) 38%, rgba(7,9,14,0.92) 100%);
            border-top: 1px solid rgba(255,255,255,0.06);
        }

        .gallery-thumbs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: thin;
        }

        .gallery-thumbs::-webkit-scrollbar { height: 6px; }
        .gallery-thumbs::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius: 999px; }

        .gallery-thumb {
            position: relative;
            display: block;
            width: 130px;
            height: 88px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 28px rgba(0,0,0,0.35);
            transition: transform .15s ease, box-shadow .2s ease, border-color .15s ease;
        }

            .gallery-thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

            .gallery-thumb:hover { transform: translateY(-2px); box-shadow: 0 14px 40px rgba(0,0,0,0.4); border-color: rgba(16,163,127,0.45); }
            .gallery-thumb:focus-visible { outline: 2px solid rgba(16,163,127,0.65); outline-offset: 2px; }
            .gallery-thumb[hidden] { display: none; }

        @@media (max-width: 900px) {
            .gallery-shell { padding: clamp(12px, 3vw, 20px); }
            .gallery-tab { padding: 9px 13px; font-size: 13px; }
            .gallery-thumb { width: 112px; height: 76px; }
        }

        @@media (max-width: 640px) {
            .gallery-shell { border-radius: 12px; }
            .gallery-tab { padding: 8px 12px; }
            .gallery-toolbar { flex-direction: column; align-items: flex-start; }
        }

        .liked-container {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .liked-scroll {
            max-height: clamp(280px, calc(100svh - 220px), 620px);
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-inline-end: 6px;
            scrollbar-gutter: stable;
        }

        .liked-header {
            max-width: 540px;
            margin: 0 auto;
        }

        .liked-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .apt-card {
            background: rgba(15,17,22,0.9);
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: calc(var(--radius) - 2px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .2s ease, box-shadow .2s ease;
        }

            .apt-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 18px 36px rgba(0,0,0,0.45);
            }

        .apt-thumb-frame {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            aspect-ratio: 4 / 3;
            max-height: 320px;
            padding: 12px;
            background: #0f1116;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            box-sizing: border-box;
        }

        .apt-thumb {
            width: 100%;
            height: 100%;
            max-height: 100%;
            object-fit: contain;
            background: #0f1116;
            border-radius: 10px;
        }

        .apt-body {
            padding: 18px 20px 22px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .apt-name {
            font-size: 17px;
            font-weight: 700;
            margin: 0;
            color: #fff;
        }

        .apt-meta {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: rgba(255,255,255,0.65);
        }

            .apt-meta .sep {
                opacity: .4;
            }

        .apt-action {
            margin-top: auto;
        }

        .liked-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 180px;
            border-radius: calc(var(--radius) - 4px);
            border: 1px dashed rgba(255,255,255,0.1);
            color: var(--muted);
            font-size: 15px;
            background: rgba(12,13,18,0.75);
        }

        .btn {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(16,163,127,0.25);
            background: linear-gradient(135deg, rgba(16,163,127,0.22), rgba(16,163,127,0.12));
            color: #e9f7f2;
            font-size: 14px;
            font-weight: 700;
            transition: transform .1s ease, box-shadow .18s ease, border-color .18s ease;
        }

            .btn:hover {
                border-color: rgba(16,163,127,0.45);
                box-shadow: 0 10px 24px rgba(16,163,127,0.2);
                color: #fff;
            }

            .btn:active {
                transform: translateY(1px);
            }

            .btn svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
            }

        /* Sticky logo */
        .logo {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 9999;
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(8px);
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            /* Responsive logo image: small on phones, larger on desktop */
            .logo img {
                display: block;
                width: clamp(90px, 20vw, 180px);
                height: auto;
                object-fit: contain;
            }

            .logo span {
                font-size: 14px;
                font-weight: 700;
                color: var(--text);
            }

        /* Right-side circular arrows */
        .nav-arrows {
            position: fixed;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9998;
        }

        .arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(0,0,0,.35);
            backdrop-filter: blur(6px);
            color: #eaecef;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background .15s ease, border-color .15s ease, transform .08s ease;
        }

            .arrow:hover {
                background: rgba(0,0,0,.45);
                border-color: var(--accent);
            }

            .arrow:active {
                transform: translateY(1px);
            }

            .arrow svg {
                width: 18px;
                height: 18px;
                stroke: currentColor;
            }

        /* Top-center banner over the movie */
        .hero-banner {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2; /* above the overlay & video */
            color: #fff;
            background: rgba(0,0,0,0.10); /* ~10% black */
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 700;
            font-size: clamp(14px, 2.5vw, 18px);
            line-height: 1.2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.25);
            text-align: center;
            white-space: nowrap;
            max-width: 90vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Smooth hide when entering interact mode */
        #sec2 .overlay,
        #sec2 .content {
            transition: opacity .25s ease;
        }

        /* Default: background mode (overlay+text visible, iframe not clickable) */
        .bg-frame-wrap iframe {
            pointer-events: none;
        }

        /* Interact mode: hide overlay + text; enable iframe pointer events */
        #sec2.interact .overlay,
        #sec2.interact .content {
            opacity: 0;
            pointer-events: none;
        }

        #sec2.interact .bg-frame-wrap iframe {
            pointer-events: auto;
        }

    </style>
</head>
<body>

    @{
        var likedItems = Model.Session?.Items ?? new List<ApartmentItem>();
        var likedItemsWithImages = likedItems
            .Where(item => !string.IsNullOrWhiteSpace(item.PlanImageUrl))
            .ToList();
        var configuredGalleryAssets = Model.Session?.GalleryAssets ?? new List<GalleryAsset>();
        var hasConfiguredGallery = configuredGalleryAssets.Any();
        List<GalleryAsset> galleryAssets;
        if (hasConfiguredGallery)
        {
            galleryAssets = configuredGalleryAssets;
        }
        else
        {
            galleryAssets = likedItemsWithImages
                .Select(item => new GalleryAsset
                {
                    ImageUrl = item.PlanImageUrl,
                    Category = "Interior"
                })
                .ToList();
        }
        var attemptedLegacyGallery = !hasConfiguredGallery && likedItems.Any();
        var fallbackGalleryHasImages = !hasConfiguredGallery && likedItemsWithImages.Any();
        var galleryItems = galleryAssets
            .Select(asset => new { Asset = asset, Category = NormalizeGalleryCategory(asset) })
            .ToList();
        var galleryCategories = new List<(string Id, string Label)>
        {
            ("Interior", "פנים"),
            ("Exterior", "חוץ"),
            ("Public", "שטחים משותפים")
        };
        var defaultGalleryCategory = galleryCategories[0].Id;
        var hasGalleryItems = galleryItems.Any();
    }

    <div class="logo">
        <img src="@Model.LogoUrl" alt="Project Logo" />
    </div>


    <div class="nav-arrows" aria-label="ניווט בין מקטעים">
        <button class="arrow" type="button" onclick="scrollPrev()" title="למעלה" aria-label="למעלה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
        <button class="arrow" type="button" onclick="scrollNext()" title="למטה" aria-label="למטה">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 9l-6 6-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
        </button>
    </div>

    <!-- SECTION 1: MOVIE AS BACKGROUND -->
    <section id="sec1" class="section">
        <video class="bg-media" src="@Model.MovieUrl" autoplay muted loop playsinline preload="auto"></video>
        <div class="overlay"></div>
        <div class="content">
            <h2>@Model.Session.ProjectId</h2>
        </div>
    </section>

    <!-- SECTION 2: SPLATTER AS BACKGROUND -->
    <section id="sec2" class="section">
        @if (!string.IsNullOrWhiteSpace(Model.SplatterUrl))
        {
            <div class="bg-frame-wrap">
                <iframe src="@Model.SplatterUrl" allow="fullscreen; xr-spatial-tracking; gyroscope; accelerometer"></iframe>
            </div>
            <div class="overlay"></div>
            <div class="content">
                <h2>סיור תלת מימד</h2>
                <p> לחץ כדי להפעיל אינטראקציה</p>
            </div>
        }
        else
        {
            <div class="content">
                <h2>סיור תלת־ממדי (Gaussian Splatting)</h2>
                <p style="color:var(--muted);">לא סופק קישור splatter — הוסיפו ‎?splat=URL לשורת הכתובת.</p>
            </div>
        }
    </section>

    <!-- SECTION 3: PROJECT GALLERY -->
    <section id="sec3" class="section gallery-section">
        <div class="gallery-shell" data-gallery-root>
            <div class="gallery-toolbar">
                <div class="gallery-header">
                    <span class="section-eyebrow">גלריית פרויקט</span>
                    <h2>תצוגת מסך מלא</h2>
                    <p>בחרו קטגוריה, דפדפו בתמונות במסך מלא ותעברו בקלות בעזרת פס התמונות.</p>
                </div>
                <div class="gallery-tabs" role="tablist">
                    @foreach (var category in galleryCategories)
                    {
                        var isActive = category.Id == defaultGalleryCategory;
                        <button type="button"
                                class="gallery-tab@(isActive ? " active" : string.Empty)"
                                role="tab"
                                aria-selected="@(isActive ? "true" : "false")"
                                data-gallery-tab
                                data-category="@category.Id">
                            @category.Label
                        </button>
                    }
                </div>
            </div>

            <div class="gallery-layout">
                <div class="gallery-hero">
                    <div class="gallery-overlay-top"></div>
                    <div class="gallery-meta">גלריה</div>
                    <img class="gallery-preview-img" data-gallery-preview-img alt="" />
                    <div class="gallery-preview-fallback" data-gallery-preview-fallback>
                        <p>בחרו קטגוריה כדי להציג את התמונות במסך מלא.</p>
                    </div>
                    <div class="gallery-thumbs-bar">
                        <div class="gallery-thumbs" data-gallery-thumbs aria-label="תמונות בקטגוריה הנוכחית">
                            @foreach (var entry in galleryItems)
                            {
                                var asset = entry.Asset;
                                var categoryLabel = GetCategoryLabel(entry.Category);
                                var displayTitle = string.IsNullOrWhiteSpace(categoryLabel) ? "תמונה" : categoryLabel;
                                <a class="gallery-thumb"
                                   href="@asset?.ImageUrl"
                                   data-gallery-thumb
                                   data-category="@entry.Category"
                                   data-image="@asset?.ImageUrl"
                                   data-title="@displayTitle"
                                   data-label="@categoryLabel"
                                   data-pswp-width="1600"
                                   data-pswp-height="900">
                                    @if (!string.IsNullOrWhiteSpace(asset?.ImageUrl))
                                    {
                                        <img src="@asset!.ImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                                    }
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 4: LIKED APARTMENTS -->
    <section id="sec4" class="section liked-section">
        <div class="liked-container">
            <div class="liked-header">
                <span class="section-eyebrow">תיק הלקוח</span>
                <h2 class="liked-title">דירות שאהבתי</h2>
                <p class="liked-subtitle">כל התכניות שסומנו במהלך הפגישה מרוכזות כאן בתצוגה אחת נוחה.</p>
            </div>

            <div class="liked-scroll">
                @if (likedItems is { Count: > 0 })
                {
                    <div class="liked-grid">
                        @foreach (var item in likedItems)
                        {
                            var displayTitle = !string.IsNullOrWhiteSpace(item.Title) ? item.Title : item.ApartmentId;
                            <article class="apt-card">
                                @if (!string.IsNullOrWhiteSpace(item.PlanImageUrl))
                                {
                                    <div class="apt-thumb-frame">
                                        <img class="apt-thumb" src="@item.PlanImageUrl" alt="@displayTitle" loading="lazy" decoding="async" />
                                    </div>
                                }
                                <div class="apt-body">
                                    <h3 class="apt-name">@displayTitle</h3>
                                    <div class="apt-meta">
                                        @if (item.Rooms.HasValue)
                                        {
                                            <span>חדרים @item.Rooms.Value</span>
                                        }
                                        @if (item.Rooms.HasValue && item.SizeSqm.HasValue)
                                        {
                                            <span class="sep">•</span>
                                        }
                                        @if (item.SizeSqm.HasValue)
                                        {
                                            <span>מ"ר @item.SizeSqm.Value.ToString("0.#")</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(item.PdfUrl))
                                    {
                                        <div class="apt-action">
                                            <a class="btn" href="@item.PdfUrl" target="_blank" rel="noopener">
                                                <svg viewBox="0 0 24 24" fill="none">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M12 15V3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                                הורדת תוכנית
                                            </a>
                                        </div>
                                    }
                                </div>
                            </article>
                        }
                    </div>
                }
                else
                {
                    <div class="liked-empty">
                        אין דירות שמורות כרגע — ודאו שקיים token חוקי ב־URL או התחילו לשמור דירות במהלך הסשן.
                    </div>
                }
            </div>
        </div>
    </section>

    <script>
        const ids = ["sec1","sec2","sec3","sec4"];
        const sec2El = document.getElementById("sec2");
        const scroller = document.scrollingElement || document.documentElement;

        // enable splatter interaction on click
        if (sec2El) {
          sec2El.addEventListener("click", e => {
            if (e.target.closest(".nav-arrows")) return;
            sec2El.classList.add("interact");
          }, { passive: true });
        }

        function resetSplatter() {
          sec2El?.classList.remove("interact");
        }

        function currentIndex() {
          const y = window.scrollY + window.innerHeight / 2;
          let best = 0, bestDist = Infinity;
          for (let i = 0; i < ids.length; i++) {
            const el = document.getElementById(ids[i]);
            if (!el) continue;
            const rect = el.getBoundingClientRect();
            const mid = rect.top + window.scrollY + rect.height / 2;
            const d = Math.abs(mid - y);
            if (d < bestDist) { bestDist = d; best = i; }
          }
          return best;
        }

        // Helper: temporarily disable snap so programmatic scroll isn't blocked
        function withSnapDisabled(fn) {
          document.documentElement.classList.add("no-snap");
          document.body.classList.add("no-snap");
          try { fn(); } finally {
            // give the browser time to start the smooth scroll, then re-enable
            setTimeout(() => {
              document.documentElement.classList.remove("no-snap");
              document.body.classList.remove("no-snap");
            }, 350);
          }
        }

        function scrollToIndex(i) {
          const el = document.getElementById(ids[i]);
          if (!el) return;
          withSnapDisabled(() => {
            // Prefer scrollIntoView for reliability across engines
            el.scrollIntoView({ behavior: "smooth", block: "start" });

            // Fallback kick (some engines need a direct scrollTo on the scroller)
            setTimeout(() => {
              const top = el.offsetTop || 0;
              scroller.scrollTo({ top, behavior: "smooth" });
            }, 0);
          });
        }

        // Upper arrow: go one section up (and reset splatter if we're currently on sec2)
        function scrollPrev() {
          const i = currentIndex();
          if (ids[i] === "sec2") resetSplatter();
          scrollToIndex(Math.max(0, i - 1));
        }

        // Lower arrow: jump straight to LAST section (Liked Apartments)
        function scrollNext() {
          resetSplatter(); // keep transition clean
          scrollToIndex(ids.length - 1); // go to sec4
        }

        // Optional: if user scrolls away from Splatter manually, restore overlay
        let scrollTimer;
        window.addEventListener("scroll", () => {
          clearTimeout(scrollTimer);
          scrollTimer = setTimeout(() => {
            const i = currentIndex();
            if (ids[i] !== "sec2") resetSplatter();
          }, 120);
        }, { passive: true });

        // Expose functions for inline onclick handlers
        window.scrollPrev = scrollPrev;
        window.scrollNext = scrollNext;

        // PhotoSwipe-powered gallery
        import('https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.js').then(({ default: PhotoSwipeLightbox }) => {
          const galleryRoot = document.querySelector('[data-gallery-root]');
          if (!galleryRoot) return;

          const tabs = Array.from(galleryRoot.querySelectorAll('[data-gallery-tab]'));
          const thumbs = Array.from(galleryRoot.querySelectorAll('[data-gallery-thumb]'));
          const previewImg = galleryRoot.querySelector('[data-gallery-preview-img]');
          const previewFallback = galleryRoot.querySelector('[data-gallery-preview-fallback]');

          let activeCategory = tabs.find(tab => tab.classList.contains('active'))?.dataset.category || tabs[0]?.dataset.category || '';

          const lightbox = new PhotoSwipeLightbox({
            gallery: '[data-gallery-root]',
            children: '[data-gallery-thumb]:not([hidden])',
            showHideAnimationType: 'zoom',
            pswpModule: () => import('https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js')
          });

          lightbox.addFilter('itemData', (itemData, element) => {
            return (!activeCategory || element.dataset.category === activeCategory) ? itemData : false;
          });

          lightbox.init();

          function updatePreview() {
            const visibleThumb = thumbs.find(thumb => !thumb.hidden && thumb.dataset.image);
            if (visibleThumb && previewImg) {
              previewImg.src = visibleThumb.dataset.image || '';
              const label = visibleThumb.dataset.label || visibleThumb.dataset.title || 'תמונה';
              previewImg.alt = label;
              previewImg.hidden = false;
              previewFallback?.setAttribute('hidden', 'hidden');
            } else if (previewImg) {
              previewImg.removeAttribute('src');
              previewImg.removeAttribute('alt');
              previewImg.hidden = true;
              previewFallback?.removeAttribute('hidden');
            }
          }

          function setCategory(category) {
            activeCategory = category;
            tabs.forEach(tab => {
              const isActive = tab.dataset.category === category;
              tab.classList.toggle('active', isActive);
              tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });

            thumbs.forEach(thumb => {
              const matches = !category || thumb.dataset.category === category;
              thumb.hidden = !matches;
            });

            updatePreview();
            lightbox.refresh();
          }

          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              setCategory(tab.dataset.category || '');
            });
          });

          if (tabs.length) {
            setCategory(activeCategory);
          } else {
            updatePreview();
          }
        });

        // Hide query parameters after load
        if (window.history.replaceState) {
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }
 

    </script>




</body>
</html>
